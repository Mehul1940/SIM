{% extends 'base.html' %}
{% load static %}

{% block content %}
<link href="{% static 'css/table.css' %}" rel="stylesheet" />

<div class="container-fluid py-4">
  <div class="page-header">
    <h1><i class="fas fa-sim-card me-3"></i>SIM Card Management</h1>
    <p class="page-subtitle">Monitor and manage SIM cards across all departments</p>
  </div>

  <form method="GET" class="filter-bar">
    <div class="filter-row">
      <div class="form-group">
        <label for="searchQuery" class="form-label">
          <i class="fas fa-search me-2"></i>Search SIM Cards
        </label>
        <div class="search-input">
          <input type="text" class="form-control" id="searchQuery" name="q"
                 placeholder="Search by Vehicle, Mobile, IMEI..." value="{{ search_query }}" />
        </div>
      </div>

      <div class="form-group">
        <label for="filterStatus" class="form-label">
          <i class="fas fa-signal me-2"></i>Status Filter
        </label>
        <select class="form-select" id="filterStatus" name="status">
          <option value="all" {% if filter_status == 'all' %}selected{% endif %}>All Statuses</option>
          {% for status in all_sim_statuses %}
            <option value="{{ status }}" {% if filter_status == status %}selected{% endif %}>{{ status }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="filterType" class="form-label">
          <i class="fas fa-tags me-2"></i>Type Filter
        </label>
        <select class="form-select" id="filterType" name="sim_type">
          <option value="all" {% if filter_type == 'all' %}selected{% endif %}>All Types</option>
          {% for sim_type in all_sim_types %}
            <option value="{{ sim_type }}" {% if filter_type == sim_type %}selected{% endif %}>{{ sim_type }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="startDate" class="form-label">
          <i class="fas fa-calendar-alt me-2"></i>From Date
        </label>
        <input type="date" class="form-control" id="startDate" name="start_date" value="{{ request.GET.start_date }}">
      </div>

      <div class="form-group">
        <label for="endDate" class="form-label">
          <i class="fas fa-calendar-alt me-2"></i>To Date
        </label>
        <input type="date" class="form-control" id="endDate" name="end_date" value="{{ request.GET.end_date }}">
      </div>
      <div class="form-group">
          <label for="departmentFilter" class="form-label">
            <i class="fas fa-building me-2"></i>Department Filter
          </label>
          <select class="form-select" name="department" id="department">
            <option value="all" {% if selected_department == 'all' %}selected{% endif %}>All Departments</option>
            {% for dept in all_departments %}
              <option value="{{ dept.name }}" {% if selected_department == dept.name %}selected{% endif %}>{{ dept.name }}</option>
            {% endfor %}
          </select>
        </div>
      <button type="submit" class="btn btn-secondary">
        <i class="fas fa-filter me-2"></i>Apply Filters
      </button>

      {% if search_query or filter_status != 'all' or filter_type != 'all' or request.GET.start_date or request.GET.end_date %}
        <a href="{% url 'departments_list' %}" class="btn btn-secondary">
          <i class="fas fa-times me-2"></i>Clear Filters
        </a>
      {% endif %}
    </div>
  </form>

  {% for department in departments %}
    <div class="department-container">
      <div class="department-header">
        <h2><i class="fas fa-building me-3 text-success"></i>{{ department.name }}</h2>
        <div class="sim-count">
          {{ department.filtered_simcards|length }} SIM card{{ department.filtered_simcards|length|pluralize }}
        </div>
        <div class="col-md-6 text-md-end">
            <a href="{% url 'simcard_create' %}" class="btn btn-outline-success">
              <i class="fas fa-plus-circle me-2"></i>Add New SIM Card
            </a>
           <a href="{% url 'simcard_export' %}?q={{ search_query }}&status={{ filter_status }}&sim_type={{ filter_type }}&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}&department={{ selected_department }}" class="btn btn-outline-info">
              <i class="fas fa-file-excel me-2"></i>Export to Excel
            </a>
          </div>
      </div>

      {% if department.filtered_simcards %}
        <div class="scroll-container">
          <table class="sim-table">
            <thead>
              <tr>
                <th><i class="fas fa-truck me-2"></i>Vehicle</th>
                <th><i class="fas fa-mobile-alt me-2"></i>Mobile</th>
                <th><i class="fas fa-fingerprint me-2"></i>IMEI</th>
                <th><i class="fas fa-map me-2"></i>Department</th>
                <th><i class="fas fa-sim-card me-2"></i>Type</th>
                <th><i class="fas fa-signal me-2"></i>Status</th>
                <th><i class="fas fa-clock me-2"></i>Last Activity</th>
                <th><i class="fas fa-fire me-2"></i>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for simcard in department.filtered_simcards %}
                <tr>
                  <td>
                    <div class="vehicle-info">
                      <div class="vehicle-reg">{{ simcard.vehicle_reg_no|default:"N/A" }}</div>
                      {% if simcard.transporter_name %}
                        <div class="transporter-name">{{ simcard.transporter_name }}</div>
                      {% endif %}
                    </div>
                  </td>
                  <td><span class="mobile-number">{{ simcard.mobile_number|default:"N/A" }}</span></td>
                  <td><span class="imei-display">{{ simcard.imei_number|truncatechars:12|default:"N/A" }}</span></td>
                  <td><span class="device-info">{{ simcard.department|default:"Unknown" }}</span></td>
                  <td><span class="sim-type-badge">{{ simcard.sim_type|default:"Standard" }}</span></td>
                  <td>
                    <span class="status-badge {% if simcard.sim_status == 'ACTIVE' %}status-active
                      {% elif simcard.sim_status == 'Available' %}status-available
                      {% elif simcard.sim_status == 'DISABLE' %}status-disable
                      {% elif simcard.sim_status == 'DEACTIVE' %}status-deactive
                      {% elif simcard.sim_status == 'IDLE' %}status-idle
                      {% elif simcard.sim_status == 'Repair' %}status-repair
                      {% elif simcard.sim_status == 'Communication_Lost' %}status-comm-lost
                      {% elif simcard.sim_status == 'GPS_Missing' %}status-gps-missing
                      {% elif simcard.sim_status == 'Temporary_Withdrawal' %}status-temp-withdraw
                      {% elif simcard.sim_status == 'Accident' %}status-accident
                      {% elif simcard.sim_status == 'Scrap' %}status-scrap
                      {% else %}status-unknown
                      {% endif %}">
                      {{ simcard.sim_status|default:"Unknown" }}
                    </span>
                  </td>
                  <td>
                    {% if simcard.last_connected %}
                      <div class="last-activity">
                        <div class="activity-date">{{ simcard.last_connected|date:"M d, Y" }}</div>
                        <div class="activity-time">{{ simcard.last_connected|time }}</div>
                      </div>
                    {% else %}
                      <span class="text-muted">Never</span>
                    {% endif %}
                  </td>
                  <td class="action-cell">
                    <a href="{% url 'simcard_update' pk=simcard.pk %}" class="btn btn-sm btn-outline-secondary" title="Edit">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a href="{% url 'simcard_delete' pk=simcard.pk %}" class="btn btn-sm btn-outline-danger" title="Delete">
                      <i class="fas fa-trash-alt"></i>
                    </a>
                    <a href="{% url 'simcard_detail' pk=simcard.pk %}" class="btn btn-sm btn-outline-primary" title="Detail">
                      <i class="fas fa-eye"></i>
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="no-sims">
          <i class="fas fa-sim-card"></i>
          <h4>No SIM Cards Found</h4>
          <p class="mb-0">No SIM cards found for this department with the current filters.</p>
        </div>
      {% endif %}
    </div>
  {% empty %}
    <div class="alert alert-info">
      <i class="fas fa-info-circle me-2"></i>
      No departments found or no SIM cards match your filter criteria.
    </div>
  {% endfor %}
</div>

<script src="{% static 'js/filter.js' %}"></script>
{% endblock %}